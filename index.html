<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>밀크티 고객센터 불만 감지 시스템</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003366">
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js');
}
</script>
<style>
    body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: #f4f6f8;
        margin: 0;
        padding: 0;
    }
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 20px;
    }
    header {
        background: linear-gradient(135deg, #003366, #00509e);
        color: white;
        padding: 20px;
        font-size: 1.8em;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        border-radius: 0 0 12px 12px;
        text-align: center;
    }
    main {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-top: 20px;
    }
    .notice {
        background-color: #f9fafb;
        border-left: 5px solid #00509e;
        padding: 15px 20px;
        margin-bottom: 20px;
        line-height: 1.6;
        font-size: 0.95em;
    }
    .notice strong {
        color: #c0392b;
        font-weight: bold;
    }
    .input-area {
        width: 100%;
        min-height: 150px;
        padding: 15px;
        box-sizing: border-box;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: white;
        outline: none;
        white-space: pre-wrap;
        word-break: break-word;
        transition: border-color 0.3s, background-color 0.3s;
    }
    .input-area:empty:before {
        content: attr(data-placeholder);
        color: #aaa;
    }
    .highlight {
        color: #c0392b;
        font-weight: bold;
    }
    .result {
        margin-top: 20px;
        padding: 20px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1.1em;
        display: none;
    }
    .normal {
        background-color: #e6f4ea;
        border: 1px solid #2e7d32;
        color: #1b5e20;
    }
    .complaint {
        background-color: transparent;
        border: none;
        color: #c0392b;
    }
    .warning {
        border-color: red !important;
        background-color: #ffe5e5;
        animation: blinkBorder 1s ease-in-out 2;
    }
    @keyframes blinkBorder {
        0%, 100% { border-color: red; }
        50% { border-color: #ff9b9b; }
    }
    .keywords {
        margin-top: 10px;
        font-size: 0.95em;
    }
    .keyword {
        display: inline-block;
        background-color: #ffcccc;
        color: #900;
        padding: 2px 6px;
        margin: 2px;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
    }
    .keyword-desc {
        margin-top: 8px;
        padding: 10px;
        background: #f1f1f1;
        border-radius: 6px;
        font-size: 0.9em;
        display: none;
    }
    .guide-text {
        font-size: 0.85em;
        color: #666;
        margin-top: 4px;
    }
    #securityStatus {
        margin-top: 20px;
        font-weight: bold;
        font-size: 0.85em;
        text-align: left;
        color: green;
    }
    /* 설치 버튼 스타일 */
    #installTrigger {
        display: none;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 1em;
        background: #003366;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
</style>
</head>
<body>

<div class="container">
    <header>밀크티 고객센터 불만 감지 시스템</header>

    <main>
        <div class="notice">
            상담 내용을 입력하면, 불만으로 의심되는 표현을 실시간으로 감지하여 결과를 나타냅니다.<br>
            해당 결과를 참고하여 <strong>VOC 구분 입력</strong>을 합니다.<br>
            <strong>이 결과는 참고용이며, 최종 판단은 상담사가 직접 해야합니다.</strong>
        </div>

        <div id="inputArea" class="input-area" contenteditable="true" spellcheck="false" data-placeholder="상담 내용을 입력하세요..."></div>

        <div id="resultBox" class="result"></div>
        <div id="keywordList" class="keywords"></div>
        <div class="guide-text" id="clickGuide" style="display:none;">감지된 키워드를 클릭하면 설명이 표시됩니다.</div>
        <div id="keywordDesc" class="keyword-desc"></div>

        <!-- 항상 보이는 설치 버튼 -->
        <button id="installTrigger">📲 앱 설치</button>
    </main>

    <div id="securityStatus">🔒 보안 상태: 안전 — 외부 전송 없음</div>
</div>

<script>
    const inputArea = document.getElementById('inputArea');
    const resultBox = document.getElementById('resultBox');
    const keywordList = document.getElementById('keywordList');
    const keywordDescBox = document.getElementById('keywordDesc');
    const clickGuide = document.getElementById('clickGuide');

    const complaintKeywords = ["불만", "불쾌", "항의", "짜증", "실망", "불친절",
    "기분 나빴", "언짢", "무례", "부당", "기분 상했", "강성", "신고", "경찰", "소보원", "소비자보호원", "소비자 보호원", "욕설", "최악", "법적대응"];

    const keywordDescriptions = {
        "불만": "서비스나 제품에 대한 전반적인 불만 표현입니다.",
        "불쾌": "고객이 기분이 상하거나 불쾌감을 느낀 상황입니다.",
        "항의": "문제 제기와 함께 시정 요구 가능성이 높습니다.",
        "짜증": "불편·불만이 감정적으로 표출된 상태입니다.",
        "실망": "기대에 미치지 못해 부정적 평가를 하는 경우입니다.",
        "불친절": "응대 태도나 서비스 매너에 대한 부정적 피드백입니다.",
        "기분 나빴": "발언·행동으로 인해 감정이 상한 상태입니다.",
        "언짢": "사소해 보이지만 불만으로 번질 수 있는 감정 표현입니다.",
        "무례": "예의 없는 태도나 발언에 대한 지적입니다.",
        "부당": "불공정·부정확한 처리에 대한 문제 제기입니다.",
        "기분 상했": "고객 감정이 크게 상한 상태로, 진정이 필요합니다.",
        "강성": "강경한 어조로 불만을 제기하는 경우입니다.",
        "신고": "외부 기관에 문제를 알리겠다는 의사 표현입니다.",
        "경찰": "법적·형사적 조치를 암시하는 발언입니다.",
        "소보원": "소비자보호원에 신고 의사를 밝히는 경우입니다.",
        "소비자보호원": "소비자보호원에 신고 의사를 밝히는 경우입니다.",
        "소비자 보호원": "소비자보호원에 신고 의사를 밝히는 경우입니다.",
        "욕설": "부적절한 언어 사용으로 감정이 격해진 상태입니다.",
        "최악": "매우 강한 부정 평가로, 불만 강도가 높습니다.",
        "법적대응": "법적 절차를 진행하겠다는 의사 표현입니다."
    };

    let isComposing = false;

    inputArea.addEventListener('compositionstart', () => { isComposing = true; });
    inputArea.addEventListener('compositionend', () => { isComposing = false; processText(); });
    inputArea.addEventListener('input', () => { if (!isComposing) processText(); });

    function processText() {
        let text = inputArea.innerText;
        if (!text.trim()) {
            resultBox.style.display = "none";
            keywordList.innerHTML = "";
            keywordDescBox.style.display = "none";
            clickGuide.style.display = "none";
            inputArea.classList.remove("warning");
            return;
        }

        // 키워드별 등장 횟수 계산
        let keywordCounts = {};
        complaintKeywords.forEach(keyword => {
            let matches = text.match(new RegExp(keyword, "g"));
            if (matches) {
                keywordCounts[keyword] = matches.length;
            }
        });

        // 키워드 하이라이트
        let highlightedText = text;
        Object.keys(keywordCounts).forEach(keyword => {
            const regex = new RegExp(keyword, "g");
            highlightedText = highlightedText.replace(regex, `<span class="highlight">${keyword}</span>`);
        });

        if (!isComposing) {
            inputArea.innerHTML = highlightedText;
            placeCaretAtEnd(inputArea);
        }

        if (Object.keys(keywordCounts).length > 0) {
            inputArea.classList.add("warning");
            resultBox.className = "result complaint";
            resultBox.innerHTML = `🚨 불만 의심`;

            // 키워드(횟수) 목록 생성
            let keywordHTML = "감지된 키워드: " + Object.entries(keywordCounts)
                .map(([k, count]) => `<span class="keyword" data-key="${k}">${k}(${count})</span>`)
                .join("");

            // 총 감지 단어 수 계산
            let totalCount = Object.values(keywordCounts).reduce((a, b) => a + b, 0);
            keywordHTML += `<div style="margin-top:5px;font-weight:bold;">총 감지 단어 수: ${totalCount}개</div>`;

            keywordList.innerHTML = keywordHTML;
            clickGuide.style.display = "block";
        } else {
            inputArea.classList.remove("warning");
            resultBox.className = "result normal";
            resultBox.textContent = "일반";
            keywordList.innerHTML = "";
            keywordDescBox.style.display = "none";
            clickGuide.style.display = "none";
        }
        resultBox.style.display = "block";

        // 키워드 클릭 시 설명 표시
        document.querySelectorAll('.keyword').forEach(span => {
            span.addEventListener('click', () => {
                const key = span.getAttribute('data-key');
                const desc = keywordDescriptions[key] || "설명 없음";
                keywordDescBox.textContent = `「${key}」 : ${desc}`;
                keywordDescBox.style.display = "block";
            });
        });
    }

    function placeCaretAtEnd(el) {
        el.focus();
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }
</script>

<!-- 🔒 보안 상태 표시 -->
<script>
const statusBox = document.getElementById('securityStatus');
statusBox.textContent = "🔒 보안 상태: 안전 — 외부 전송 없음";
statusBox.style.color = "green";

// fetch 감시
const originalFetch = window.fetch;
window.fetch = function(...args) {
    statusBox.textContent = "🚨 보안 경고: 외부로 데이터 전송 시도 감지됨!";
    statusBox.style.color = "red";
    return originalFetch.apply(this, args);
};

// XMLHttpRequest 감시
const originalXHR = window.XMLHttpRequest;
function MonitorXHR() {
    const xhr = new originalXHR();
    xhr.addEventListener('loadstart', () => {
        statusBox.textContent = "🚨 보안 경고: 외부로 데이터 전송 시도 감지됨!";
        statusBox.style.color = "red";
    });
    return xhr;
}
window.XMLHttpRequest = MonitorXHR;
</script>

<!-- 설치 버튼 동작 -->
<script>
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installTrigger').style.display = 'block';
});

document.getElementById('installTrigger').addEventListener('click', () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => {
      deferredPrompt = null;
      document.getElementById('installTrigger').style.display = 'none';
    });
  }
});
</script>

</body>
</html>

